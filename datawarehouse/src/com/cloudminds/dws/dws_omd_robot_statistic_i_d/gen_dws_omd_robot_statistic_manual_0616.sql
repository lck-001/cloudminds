set hive.exec.dynamic.partition.mode = nonstrict;
set hive.merge.mapfiles = true;
set hive.merge.mapredfiles = true;
set hive.exec.max.dynamic.partitions = 60000;
set mapreduce.job.queuename=root.prod;
set spark.executor.memory = 4G;

with test as (
    select
        --   tenant dim
        tenant__tenant_id,
        tenant__tenant_name,
        tenant__tenant_type,
        tenant__industry_id,
        tenant__sub_sys,
        tenant__time_zone,
        tenant__net_env_id,
        tenant__mcs_area,
        tenant__device_num,
        tenant__region,
        tenant__address,
        tenant__contact,
        tenant__phone,
        tenant__telephone,
        tenant__seller,
        tenant__email,
        tenant__status,
        tenant__status_name,
        tenant__charge_time,
        tenant__expired_time,
        tenant__logo,
        tenant__description,
        tenant__brand,
        tenant__is_need_vpn,
        tenant__create_time,
        tenant__industry_name,
        --  robot dim
        robot__robot_id,
        robot__robot_name,
        robot__robot_type_id,
        robot__robot_type_inner_name,
        robot__robot_type_name,
        robot__asset_code,
        robot__asset_type,
        robot__product_type_code,
        robot__product_type_code_name,
        robot__product_id,
        robot__product_id_name,
        robot__assets_status,
        robot__assets_status_name,
        robot__status,
        robot__status_name,
        robot__robot_manufacturer_id,
        robot__robot_manufacturer_name,
        robot__model,
        robot__os,
        robot__version_code,
        robot__software_version,
        robot__hardware_version,
        robot__head_url,
        robot__regist_time,
        robot__bind_status,
        robot__bind_status_name,
        robot__is_hi_service,
        robot__is_privacy_enhance,
        robot__remind_policy_id,
        robot__sku,
        robot__quality_date,
        robot__customer_quality_date,
        robot__out_type_state,
        robot__out_type_state_name,
        robot__product_date,
        robot__in_stock_date,
        robot__out_stock_date,
        robot__in_stock_staff_id,
        robot__in_stock_staff_name,
        robot__out_stock_staff_id,
        robot__out_stock_staff_name,
        robot__robot_note,
        robot__description,
        robot__create_time,
        --customer dim
        customer__customer_id,
        customer__customer_name,
        customer__pid,
        customer__level,
        customer__region,
        customer__address,
        customer__website,
        customer__nature_code,
        customer__nature_name,
        customer__credit_code,
        customer__credit_name,
        customer__source_code,
        customer__source_name,
        customer__scale_code,
        customer__scale_name,
        customer__status_code,
        customer__status_name,
        customer__contact_code,
        customer__contact_name,
        customer__purchase_code,
        customer__purchase_name,
        customer__employment_code,
        customer__employment_name,
        customer__settlement_code,
        customer__settlement_name,
        customer__employer_num,
        customer__category_code,
        customer__category_name,
        customer__create_time,
        rcu_id,
        k8s_env_name,
        sv_agent_id,
        event_date,
        dt,
        sum(robot_online_time) as robot_online_time,
        sum(robot_offline_times) as robot_offline_times,
        sum(robot_online_times) as robot_online_times
    from (
        SELECT
    --   tenant dim
            tenant__tenant_id,
            tenant__tenant_name,
            tenant__tenant_type,
            tenant__industry_id,
            tenant__sub_sys,
            tenant__time_zone,
            tenant__net_env_id,
            tenant__mcs_area,
            tenant__device_num,
            tenant__region,
            tenant__address,
            tenant__contact,
            tenant__phone,
            tenant__telephone,
            tenant__seller,
            tenant__email,
            tenant__status,
            tenant__status_name,
            tenant__charge_time,
            tenant__expired_time,
            tenant__logo,
            tenant__description,
            tenant__brand,
            tenant__is_need_vpn,
            tenant__create_time,
            tenant__industry_name,
    --  robot dim
            robot__robot_id,
            robot__robot_name,
            robot__robot_type_id,
            robot__robot_type_inner_name,
            robot__robot_type_name,
            robot__asset_code,
            robot__asset_type,
            robot__product_type_code,
            robot__product_type_code_name,
            robot__product_id,
            robot__product_id_name,
            robot__assets_status,
            robot__assets_status_name,
            robot__status,
            robot__status_name,
            robot__robot_manufacturer_id,
            robot__robot_manufacturer_name,
            robot__model,
            robot__os,
            robot__version_code,
            robot__software_version,
            robot__hardware_version,
            robot__head_url,
            robot__regist_time,
            robot__bind_status,
            robot__bind_status_name,
            robot__is_hi_service,
            robot__is_privacy_enhance,
            robot__remind_policy_id,
            robot__sku,
            robot__quality_date,
            robot__customer_quality_date,
            robot__out_type_state,
            robot__out_type_state_name,
            robot__product_date,
            robot__in_stock_date,
            robot__out_stock_date,
            robot__in_stock_staff_id,
            robot__in_stock_staff_name,
            robot__out_stock_staff_id,
            robot__out_stock_staff_name,
            robot__robot_note,
            robot__description,
            robot__create_time,
    --customer dim
            customer__customer_id,
            customer__customer_name,
            customer__pid,
            customer__level,
            customer__region,
            customer__address,
            customer__website,
            customer__nature_code,
            customer__nature_name,
            customer__credit_code,
            customer__credit_name,
            customer__source_code,
            customer__source_name,
            customer__scale_code,
            customer__scale_name,
            customer__status_code,
            customer__status_name,
            customer__contact_code,
            customer__contact_name,
            customer__purchase_code,
            customer__purchase_name,
            customer__employment_code,
            customer__employment_name,
            customer__settlement_code,
            customer__settlement_name,
            customer__employer_num,
            customer__category_code,
            customer__category_name,
            customer__create_time,
            rcu_id,
            k8s_env_name,
            sv_agent_id,
            to_date(event_time) as event_date,
            dt,
            case when event_type = 'robotOnlineTick60' then 1
                 when event_type = 'robotOnlineTick' then 10 else 0 end as robot_online_time,
            case when event_type = 'robotAbnormalDisconnect' then 1 else 0 end as robot_offline_times,
            case when event_type = 'robotConnect' then 1 else 0 end as robot_online_times
        from cdmdwm.dwm_omd_robot_running_event_i_d
        WHERE dt >='2021-09-01' and dt <= '2022-06-15'
        ) as tmp group by  --   tenant dim
                           tenant__tenant_id,
                           tenant__tenant_name,
                           tenant__tenant_type,
                           tenant__industry_id,
                           tenant__sub_sys,
                           tenant__time_zone,
                           tenant__net_env_id,
                           tenant__mcs_area,
                           tenant__device_num,
                           tenant__region,
                           tenant__address,
                           tenant__contact,
                           tenant__phone,
                           tenant__telephone,
                           tenant__seller,
                           tenant__email,
                           tenant__status,
                           tenant__status_name,
                           tenant__charge_time,
                           tenant__expired_time,
                           tenant__logo,
                           tenant__description,
                           tenant__brand,
                           tenant__is_need_vpn,
                           tenant__create_time,
                           tenant__industry_name,
                           --  robot dim
                           robot__robot_id,
                           robot__robot_name,
                           robot__robot_type_id,
                           robot__robot_type_inner_name,
                           robot__robot_type_name,
                           robot__asset_code,
                           robot__asset_type,
                           robot__product_type_code,
                           robot__product_type_code_name,
                           robot__product_id,
                           robot__product_id_name,
                           robot__assets_status,
                           robot__assets_status_name,
                           robot__status,
                           robot__status_name,
                           robot__robot_manufacturer_id,
                           robot__robot_manufacturer_name,
                           robot__model,
                           robot__os,
                           robot__version_code,
                           robot__software_version,
                           robot__hardware_version,
                           robot__head_url,
                           robot__regist_time,
                           robot__bind_status,
                           robot__bind_status_name,
                           robot__is_hi_service,
                           robot__is_privacy_enhance,
                           robot__remind_policy_id,
                           robot__sku,
                           robot__quality_date,
                           robot__customer_quality_date,
                           robot__out_type_state,
                           robot__out_type_state_name,
                           robot__product_date,
                           robot__in_stock_date,
                           robot__out_stock_date,
                           robot__in_stock_staff_id,
                           robot__in_stock_staff_name,
                           robot__out_stock_staff_id,
                           robot__out_stock_staff_name,
                           robot__robot_note,
                           robot__description,
                           robot__create_time,
                           --customer dim
                           customer__customer_id,
                           customer__customer_name,
                           customer__pid,
                           customer__level,
                           customer__region,
                           customer__address,
                           customer__website,
                           customer__nature_code,
                           customer__nature_name,
                           customer__credit_code,
                           customer__credit_name,
                           customer__source_code,
                           customer__source_name,
                           customer__scale_code,
                           customer__scale_name,
                           customer__status_code,
                           customer__status_name,
                           customer__contact_code,
                           customer__contact_name,
                           customer__purchase_code,
                           customer__purchase_name,
                           customer__employment_code,
                           customer__employment_name,
                           customer__settlement_code,
                           customer__settlement_name,
                           customer__employer_num,
                           customer__category_code,
                           customer__category_name,
                           customer__create_time,
                           rcu_id,
                           k8s_env_name,
                           sv_agent_id,
                           dt,
                           event_date
)


insert overwrite table cdmdws.dws_omd_robot_statistic_i_d  partition(dt)
select
    rcu_id,
    k8s_env_name,
    sv_agent_id,
--   tenant dim
    tenant__tenant_id,
    tenant__tenant_name,
    tenant__tenant_type,
    tenant__industry_id,
    tenant__sub_sys,
    tenant__time_zone,
    tenant__net_env_id,
    tenant__mcs_area,
    tenant__device_num,
    tenant__region,
    tenant__address,
    tenant__contact,
    tenant__phone,
    tenant__telephone,
    tenant__seller,
    tenant__email,
    tenant__status,
    tenant__status_name,
    tenant__charge_time,
    tenant__expired_time,
    tenant__logo,
    tenant__description,
    tenant__brand,
    tenant__is_need_vpn,
    tenant__create_time,
    tenant__industry_name,
    --  robot dim
    robot__robot_id,
    robot__robot_name,
    robot__robot_type_id,
    robot__robot_type_inner_name,
    robot__robot_type_name,
    robot__asset_code,
    robot__asset_type,
    robot__product_type_code,
    robot__product_type_code_name,
    robot__product_id,
    robot__product_id_name,
    robot__assets_status,
    robot__assets_status_name,
    robot__status,
    robot__status_name,
    robot__robot_manufacturer_id,
    robot__robot_manufacturer_name,
    robot__model,
    robot__os,
    robot__version_code,
    robot__software_version,
    robot__hardware_version,
    robot__head_url,
    robot__regist_time,
    robot__bind_status,
    robot__bind_status_name,
    robot__is_hi_service,
    robot__is_privacy_enhance,
    robot__remind_policy_id,
    robot__sku,
    robot__quality_date,
    robot__customer_quality_date,
    robot__out_type_state,
    robot__out_type_state_name,
    robot__product_date,
    robot__in_stock_date,
    robot__out_stock_date,
    robot__in_stock_staff_id,
    robot__in_stock_staff_name,
    robot__out_stock_staff_id,
    robot__out_stock_staff_name,
    robot__robot_note,
    robot__description,
    robot__create_time,
    --customer dim
    customer__customer_id,
    customer__customer_name,
    customer__pid,
    customer__level,
    customer__region,
    customer__address,
    customer__website,
    customer__nature_code,
    customer__nature_name,
    customer__credit_code,
    customer__credit_name,
    customer__source_code,
    customer__source_name,
    customer__scale_code,
    customer__scale_name,
    customer__status_code,
    customer__status_name,
    customer__contact_code,
    customer__contact_name,
    customer__purchase_code,
    customer__purchase_name,
    customer__employment_code,
    customer__employment_name,
    customer__settlement_code,
    customer__settlement_name,
    customer__employer_num,
    customer__category_code,
    customer__category_name,
    customer__create_time,
    event_date,
    robot_online_time,
    robot_offline_times,
    robot_online_times,
    lj.operating_status as robot__operating_status,
    lj.operating_status_name as robot__operating_status_name,
    dt
from test tt
left join (
    select
        operating_status,
        operating_status_name,
        robot_id
    from cdmtmp.tmp_dim_pmd_robot_sh_d_luojun_20220130
    where dt = date_sub(current_date, 1)
    ) lj
    on tt.robot__robot_id = lj.robot_id
    distribute by tt.dt